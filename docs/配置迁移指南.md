# é…ç½®è¿ç§»æŒ‡å—

> **ç›®æ ‡**ï¼šä»æ—§é…ç½®ä½“ç³»è¿ç§»åˆ°æ ‡å‡†åŒ–é…ç½®ä½“ç³»  
> **é€‚ç”¨åœºæ™¯**ï¼šå·²æœ‰é¡¹ç›®éƒ¨ç½²ï¼Œéœ€è¦å‡çº§åˆ°æ–°é…ç½®ç»“æ„

---

## ğŸ“‹ è¿ç§»æ¦‚è§ˆ

### é…ç½®å˜æ›´å¯¹ç…§è¡¨

| æ—§é…ç½®æ–‡ä»¶ | æ–°é…ç½®æ–‡ä»¶ | å˜æ›´è¯´æ˜ |
|-----------|-----------|---------|
| `docker-compose.yml` | `docker-compose.dev.yml` | é‡å‘½åå¹¶æ ‡å‡†åŒ– |
| `docker-compose-server.yml` | `docker-compose.prod.yml` | é‡å‘½åå¹¶ç§»é™¤ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ |
| `application-docker.yml` | `application-dev.yml` + `application-prod.yml` | æ‹†åˆ†ä¸ºç¯å¢ƒä¸“ç”¨é…ç½® |
| - | `application.yml` | æ–°å¢é€šç”¨åŸºç¡€é…ç½® |

---

## ğŸš€ è¿ç§»æ­¥éª¤

### æ­¥éª¤1ï¼šå¤‡ä»½ç°æœ‰é…ç½®

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p backup/config

# å¤‡ä»½æ—§é…ç½®æ–‡ä»¶
cp docker-compose.yml backup/config/
cp docker-compose-server.yml backup/config/
cp backend/src/main/resources/application-docker.yml backup/config/
cp .env backup/config/

echo "é…ç½®å¤‡ä»½å®Œæˆï¼Œä¿å­˜åœ¨ backup/config/ ç›®å½•"
```

### æ­¥éª¤2ï¼šæå–æ•æ„Ÿä¿¡æ¯

ä»æ—§é…ç½®ä¸­æå–ä»¥ä¸‹ä¿¡æ¯å¹¶è®°å½•ï¼š

#### ä» `docker-compose-server.yml` æå–

```yaml
# éœ€è¦è®°å½•çš„ä¿¡æ¯ï¼š
environment:
  ALIYUN_API_KEY: sk-xxxxxxxxxxxxxxxx        # é˜¿é‡Œäº‘APIå¯†é’¥
  DEEPSEEK_API_KEY: sk-xxxxxxxxxxxxxxxx      # DeepSeek APIå¯†é’¥
  JWT_SECRET: xxxxxxxxxxxxx                  # JWTå¯†é’¥
  SPRING_DATASOURCE_PASSWORD: xxxxxxxx       # æ•°æ®åº“å¯†ç 

image: registry.xxx.com/xxx/echocampus:latest  # Dockeré•œåƒåœ°å€
```

#### ä» `.env` æå–

```bash
ALIYUN_API_KEY=sk-xxxxxxxxxxxxxxxx
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxx
# ... å…¶ä»–é…ç½®
```

### æ­¥éª¤3ï¼šæ‹‰å–æœ€æ–°ä»£ç 

```bash
git pull origin main
```

æ‹‰å–åä¼šè·å¾—ä»¥ä¸‹æ–°æ–‡ä»¶ï¼š
- `docker-compose.dev.yml`
- `docker-compose.prod.yml`
- `backend/src/main/resources/application-dev.yml`
- `backend/src/main/resources/application-prod.yml`
- æ›´æ–°çš„ `application.yml`
- æ›´æ–°çš„ `.env.example`

### æ­¥éª¤4ï¼šé…ç½®æ–°çš„ç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
# å¤åˆ¶æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘.envæ–‡ä»¶ï¼Œå¡«å…¥æ­¥éª¤2è®°å½•çš„ä¿¡æ¯
nano .env  # æˆ–ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨
```

å¡«å…¥ä»¥ä¸‹ä¿¡æ¯ï¼š

```bash
# æ•°æ®åº“é…ç½®
POSTGRES_DB=echocampus_bot
POSTGRES_USER=postgres
POSTGRES_PASSWORD=<ä»æ—§é…ç½®æå–çš„æ•°æ®åº“å¯†ç >
POSTGRES_PORT=5432

# åç«¯æœåŠ¡ç«¯å£
BACKEND_PORT=8083

# AIæœåŠ¡å¯†é’¥ï¼ˆä»æ—§é…ç½®æå–ï¼‰
ALIYUN_API_KEY=<ä»æ—§é…ç½®æå–çš„é˜¿é‡Œäº‘å¯†é’¥>
DEEPSEEK_API_KEY=<ä»æ—§é…ç½®æå–çš„DeepSeekå¯†é’¥>

# JWTå¯†é’¥ï¼ˆä»æ—§é…ç½®æå–ï¼‰
JWT_SECRET=<ä»æ—§é…ç½®æå–çš„JWTå¯†é’¥>

# é‚®ä»¶æœåŠ¡é…ç½®ï¼ˆå¦‚æœ‰ï¼‰
MAIL_USERNAME=<é‚®ç®±ç”¨æˆ·å>
MAIL_PASSWORD=<é‚®ç®±æˆæƒç >

# === ä»…ç”Ÿäº§ç¯å¢ƒéœ€è¦ ===
# CORSé…ç½®
CORS_ALLOWED_ORIGINS=<å‰ç«¯åŸŸå>

# Dockeré•œåƒï¼ˆä»æ—§é…ç½®æå–ï¼‰
DOCKER_IMAGE=<ä»æ—§é…ç½®æå–çš„é•œåƒåœ°å€>
```

### æ­¥éª¤5ï¼šæ¸…ç†æ—§é…ç½®æ–‡ä»¶

```bash
# åˆ é™¤æ—§é…ç½®æ–‡ä»¶ï¼ˆå·²å¤‡ä»½ï¼Œå¯å®‰å…¨åˆ é™¤ï¼‰
rm docker-compose.yml
rm docker-compose-server.yml
rm backend/src/main/resources/application-docker.yml

echo "æ—§é…ç½®æ–‡ä»¶å·²åˆ é™¤"
```

### æ­¥éª¤6ï¼šéªŒè¯æ–°é…ç½®

#### æœ¬åœ°å¼€å‘ç¯å¢ƒéªŒè¯

```bash
# 1. æ„å»ºåç«¯
cd backend
mvn clean package -DskipTests
cd ..

# 2. å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.dev.yml up -d --build

# 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.dev.yml ps

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.dev.yml logs -f echocampus-bot

# 5. æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8083/api/v1/health
```

#### ç”Ÿäº§ç¯å¢ƒéªŒè¯

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ

# 1. åœæ­¢æ—§æœåŠ¡
docker-compose down  # ä½¿ç”¨æ—§çš„docker-compose.yml

# 2. å¯åŠ¨æ–°æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d

# 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# 4. æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8083/api/v1/health
```

---

## ğŸ” è¿ç§»æ£€æŸ¥æ¸…å•

### é…ç½®æ–‡ä»¶æ£€æŸ¥

- [ ] æ–°çš„ `.env` æ–‡ä»¶å·²åˆ›å»ºå¹¶å¡«å…¥æ­£ç¡®çš„é…ç½®
- [ ] æ—§çš„ `docker-compose.yml` å·²åˆ é™¤æˆ–å¤‡ä»½
- [ ] æ—§çš„ `docker-compose-server.yml` å·²åˆ é™¤æˆ–å¤‡ä»½
- [ ] æ—§çš„ `application-docker.yml` å·²åˆ é™¤æˆ–å¤‡ä»½
- [ ] `.gitignore` æ­£ç¡®é…ç½®ï¼Œ`.env` æ–‡ä»¶ä¸ä¼šè¢«æäº¤

### åŠŸèƒ½éªŒè¯æ£€æŸ¥

- [ ] åç«¯æœåŠ¡å¯ä»¥æ­£å¸¸å¯åŠ¨
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] Milvuså‘é‡æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] APIæ–‡æ¡£å¯ä»¥è®¿é—®ï¼ˆhttp://localhost:8083/api/doc.htmlï¼‰
- [ ] å¥åº·æ£€æŸ¥æ¥å£æ­£å¸¸ï¼ˆhttp://localhost:8083/api/v1/healthï¼‰
- [ ] AIæœåŠ¡è°ƒç”¨æ­£å¸¸ï¼ˆEmbeddingå’ŒLLMï¼‰
- [ ] å‰ç«¯å¯ä»¥æ­£å¸¸è¿æ¥åç«¯

### å®‰å…¨æ£€æŸ¥

- [ ] `.env` æ–‡ä»¶å·²åŠ å…¥ `.gitignore`
- [ ] é…ç½®æ–‡ä»¶ä¸­æ— ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯
- [ ] ç”Ÿäº§ç¯å¢ƒä½¿ç”¨äº†å¼ºå¯†ç å’ŒJWTå¯†é’¥
- [ ] Gitå†å²ä¸­çš„æ•æ„Ÿä¿¡æ¯å·²æ¸…ç†ï¼ˆå¦‚éœ€å¼€æºï¼‰

---

## âš ï¸ å¸¸è§è¿ç§»é—®é¢˜

### é—®é¢˜1ï¼šDockerå®¹å™¨æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**ï¼šæ‰§è¡Œ `docker-compose up` æŠ¥é”™

**åŸå› **ï¼šä½¿ç”¨äº†æ—§çš„å‘½ä»¤æ ¼å¼

**è§£å†³**ï¼š
```bash
# âŒ é”™è¯¯ç”¨æ³•
docker-compose up

# âœ… æ­£ç¡®ç”¨æ³•
docker-compose -f docker-compose.dev.yml up -d    # æœ¬åœ°å¼€å‘
docker-compose -f docker-compose.prod.yml up -d   # ç”Ÿäº§ç¯å¢ƒ
```

### é—®é¢˜2ï¼šç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šåç«¯æ—¥å¿—æ˜¾ç¤ºAPIå¯†é’¥æœªé…ç½®

**åŸå› **ï¼š`.env` æ–‡ä»¶ä½ç½®ä¸æ­£ç¡®æˆ–æ ¼å¼é”™è¯¯

**è§£å†³**ï¼š
```bash
# 1. æ£€æŸ¥.envæ–‡ä»¶ä½ç½®ï¼ˆå¿…é¡»åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼‰
ls -la .env

# 2. æ£€æŸ¥.envæ–‡ä»¶æ ¼å¼ï¼ˆKEY=VALUEï¼Œä¸è¦æœ‰ç©ºæ ¼ï¼‰
cat .env

# 3. é‡å¯å®¹å™¨
docker-compose -f docker-compose.dev.yml restart
```

### é—®é¢˜3ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šåç«¯æ— æ³•è¿æ¥PostgreSQL

**åŸå› **ï¼šæ•°æ®åº“å¯†ç é…ç½®ä¸æ­£ç¡®

**è§£å†³**ï¼š
```bash
# 1. æ£€æŸ¥.envä¸­çš„æ•°æ®åº“å¯†ç 
grep POSTGRES_PASSWORD .env

# 2. æ£€æŸ¥å®¹å™¨ç¯å¢ƒå˜é‡
docker-compose -f docker-compose.dev.yml exec echocampus-bot env | grep POSTGRES

# 3. å¦‚æœå¯†ç é”™è¯¯ï¼Œä¿®æ”¹.envåé‡å¯
docker-compose -f docker-compose.dev.yml down
docker-compose -f docker-compose.dev.yml up -d
```

### é—®é¢˜4ï¼šç”Ÿäº§ç¯å¢ƒé•œåƒæ‹‰å–å¤±è´¥

**ç—‡çŠ¶**ï¼š`docker-compose up` æ— æ³•æ‹‰å–é•œåƒ

**åŸå› **ï¼š`.env` ä¸­çš„ `DOCKER_IMAGE` é…ç½®ä¸æ­£ç¡®

**è§£å†³**ï¼š
```bash
# 1. æ£€æŸ¥é•œåƒé…ç½®
grep DOCKER_IMAGE .env

# 2. ç¡®ä¿é•œåƒåœ°å€æ­£ç¡®
DOCKER_IMAGE=registry.cn-shanghai.aliyuncs.com/your-namespace/echocampus-bot:latest

# 3. ç™»å½•é•œåƒä»“åº“
docker login registry.cn-shanghai.aliyuncs.com

# 4. æ‰‹åŠ¨æ‹‰å–æµ‹è¯•
docker pull <é•œåƒåœ°å€>
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœè¿ç§»è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨å¤‡ä»½é…ç½®

```bash
# 1. åœæ­¢æ–°é…ç½®çš„æœåŠ¡
docker-compose -f docker-compose.dev.yml down

# 2. æ¢å¤æ—§é…ç½®
cp backup/config/docker-compose.yml .
cp backup/config/docker-compose-server.yml .
cp backup/config/application-docker.yml backend/src/main/resources/
cp backup/config/.env .

# 3. å¯åŠ¨æ—§æœåŠ¡
docker-compose up -d

echo "å·²å›æ»šåˆ°æ—§é…ç½®"
```

### æ–¹æ¡ˆ2ï¼šä»Gitæ¢å¤

```bash
# 1. åœæ­¢æœåŠ¡
docker-compose down

# 2. å›é€€Gitæäº¤
git log  # æŸ¥æ‰¾è¿ç§»å‰çš„commit
git reset --hard <commit-hash>

# 3. é‡å¯æœåŠ¡
docker-compose up -d
```

---

## ğŸ“Š è¿ç§»åä¼˜åŒ–å»ºè®®

### 1. æ¸…ç†Gitå†å²ï¼ˆå¦‚éœ€å¼€æºï¼‰

```bash
# ä½¿ç”¨BFG Repo-Cleaneræ¸…ç†æ•æ„Ÿä¿¡æ¯
# ä¸‹è½½åœ°å€ï¼šhttps://rtyley.github.io/bfg-repo-cleaner/

# æ¸…ç†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ–‡ä»¶
java -jar bfg.jar --delete-files docker-compose-server.yml
java -jar bfg.jar --delete-files application-docker.yml

# æ¸…ç†æäº¤å†å²
git reflog expire --expire=now --all && git gc --prune=now --aggressive
```

### 2. æ›´æ–°CI/CDé…ç½®

å¦‚æœä½¿ç”¨CI/CDï¼Œéœ€è¦æ›´æ–°éƒ¨ç½²è„šæœ¬ï¼š

```yaml
# ç¤ºä¾‹ï¼šGitHub Actions
deploy:
  steps:
    - name: Deploy to production
      run: |
        docker-compose -f docker-compose.prod.yml pull
        docker-compose -f docker-compose.prod.yml up -d
```

### 3. æ›´æ–°æ–‡æ¡£

æ›´æ–°ä»¥ä¸‹æ–‡æ¡£ä¸­çš„é…ç½®å¼•ç”¨ï¼š
- README.md
- éƒ¨ç½²æ–‡æ¡£
- è¿ç»´æ‰‹å†Œ

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœè¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹é…ç½®å®¡è®¡æŠ¥å‘Š**ï¼š`docs/é…ç½®å®¡è®¡æŠ¥å‘Š.md`
2. **æŸ¥çœ‹å¿«é€Ÿéƒ¨ç½²æŒ‡å—**ï¼š`docs/å¿«é€Ÿéƒ¨ç½²æŒ‡å—.md`
3. **æŸ¥çœ‹ç¯å¢ƒå˜é‡è¯´æ˜**ï¼š`docs/ç¯å¢ƒå˜é‡é…ç½®è¯´æ˜.md`
4. **æ£€æŸ¥æ—¥å¿—**ï¼š`docker-compose -f docker-compose.{dev|prod}.yml logs`

---

**è¿ç§»æ„‰å¿«ï¼** ğŸ‰

---
