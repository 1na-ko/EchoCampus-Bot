# 后端部署流程

## 服务器配置信息

- **SSH 登录**：`ssh <用户名>@<服务器IP>`
- **密码**：`<服务器密码>`
- **前端位置**：`/opt/student-projects/<用户名>/html/`
- **后端端口**：`8083`
- **Docker 项目目录**：`/home/<用户名>/docker-projects/`
- **阿里云镜像仓库**：`crpi-eevftpl120852maz.cn-shanghai.personal.cr.aliyuncs.com`
- **镜像仓库命名空间**：`inako_docker`
- **镜像名称**：`echocampus`

## 部署流程

### 1. 本地修改代码
修改后端代码（如 `JwtAuthInterceptor.java` 等）

### 2. 本地打包
```bash
cd backend
mvn clean package -DskipTests
```

### 3. 构建 Docker 镜像
```bash
# 返回项目根目录
cd ..
docker build -t echocampus:latest ./backend
```

### 4. 登录阿里云镜像仓库
```bash
docker login --username=<阿里云用户名> crpi-eevftpl120852maz.cn-shanghai.personal.cr.aliyuncs.com
# 输入阿里云密码
```

### 5. 标记镜像
```bash
docker tag echocampus:latest crpi-eevftpl120852maz.cn-shanghai.personal.cr.aliyuncs.com/inako_docker/echocampus:latest
```

### 6. 推送镜像到阿里云
```bash
docker push crpi-eevftpl120852maz.cn-shanghai.personal.cr.aliyuncs.com/inako_docker/echocampus:latest
```

### 7. 连接服务器并登录阿里云
```bash
ssh <用户名>@<服务器IP>
docker login --username=<阿里云用户名> crpi-eevftpl120852maz.cn-shanghai.personal.cr.aliyuncs.com
```

### 8. 拉取最新镜像
```bash
docker pull crpi-eevftpl120852maz.cn-shanghai.personal.cr.aliyuncs.com/inako_docker/echocampus:latest
```

### 9. 使用 docker-compose 重启服务（重要！）
```bash
cd /home/<用户名>/docker-projects
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.prod.yml up -d
```

### 10. 验证服务状态
```bash
docker ps | grep echocampus
curl http://localhost:8083/api/v1/health
docker logs echocampus-bot-prod --tail 30
```

---

## 前端部署流程

### 1. 打包 Vue 项目

```bash
# 进入前端项目目录
cd frontend

# 安装依赖（本地通常已安装，可忽略）
pnpm install

# 打包生成 dist 文件夹
pnpm run build
```

打包后会在项目目录生成 `dist` 文件夹，里面就是需要上传的文件。

### 2. 上传到服务器

```bash
# 上传整个 dist 文件夹内容到服务器
scp -r ./dist/* <用户名>@<服务器IP>:/opt/student-projects/<用户名>/html/
# 输入服务器密码

# 如果是单个 html 文件
scp index.html <用户名>@<服务器IP>:/opt/student-projects/<用户名>/html/
```

---

## 关键注意事项

1. **必须使用 docker-compose**：服务器上的服务依赖 PostgreSQL、Milvus、etcd、MinIO 等组件，必须通过 docker-compose 启动才能正确连接
2. **不要使用 docker run 独立启动**：独立启动会导致数据库连接失败
3. **端口映射**：后端服务映射为 `8083:8080`（宿主机端口:容器端口）
4. **配置文件位置**：服务器上的 docker-compose.prod.yml 位于 `/home/<用户名>/docker-projects/docker-compose.prod.yml`

## 服务依赖说明

后端服务依赖以下组件（通过 docker-compose 管理）：

- **PostgreSQL**：主数据库，端口 5432
- **Milvus**：向量数据库，端口 19530
- **etcd**：Milvus 元数据存储
- **MinIO**：Milvus 对象存储，端口 9000/9001

## 常见问题

### 502 Bad Gateway
- 原因：使用 `docker run` 独立启动容器，导致数据库连接失败
- 解决：使用 `docker compose -f docker-compose.prod.yml up -d` 启动所有服务

### 401 未提供认证token
- 原因：SSE 连接未传递认证 token
- 解决：修改 `JwtAuthInterceptor.java` 支持从 URL 参数提取 token

### 容器启动失败
- 查看日志：`docker logs echocampus-bot-prod`
- 检查依赖服务：`docker ps | grep echocampus`
- 重启服务：`cd /home/<用户名>/docker-projects && docker compose -f docker-compose.prod.yml restart`
