# 后端部署流程

## 服务器配置信息

- SSH 登录：`ssh <用户名>@<服务器IP>`
- 密码：`<服务器密码>`
- 前端位置：`/opt/student-projects/<用户名>/html/`
- 后端端口：`<后端端口>`
- Docker 项目目录：`/home/<用户名>/docker-projects/`
- 阿里云镜像仓库：`<阿里云镜像仓库地址>`
- 阿里云用户名：`<阿里云用户名>`
- 阿里云密码：`<阿里云密码>`

## 部署流程

### 1. 本地修改代码
修改后端代码（如 `JwtAuthInterceptor.java` 等）

### 2. 本地打包
```bash
cd backend
mvn clean package -DskipTests
```

### 3. 构建 Docker 镜像
```bash
docker build -t echocampus:latest .
```

### 4. 登录阿里云镜像仓库
```bash
echo "<阿里云密码>" | docker login --username=<阿里云用户名> --password-stdin <阿里云镜像仓库地址>
```

### 5. 标记镜像
```bash
docker tag echocampus:latest <阿里云镜像仓库地址>/<命名空间>/<仓库名>:latest
```

### 6. 推送镜像到阿里云
```bash
docker push <阿里云镜像仓库地址>/<命名空间>/<仓库名>:latest
```

### 7. 连接服务器并登录阿里云
```bash
ssh <用户名>@<服务器IP>
echo "<阿里云密码>" | docker login --username=<阿里云用户名> --password-stdin <阿里云镜像仓库地址>
```

### 8. 拉取最新镜像
```bash
docker pull <阿里云镜像仓库地址>/<命名空间>/<仓库名>:latest
```

### 9. 使用 docker-compose 重启服务（重要！）
```bash
cd /home/<用户名>/docker-projects
docker compose down
docker compose up -d
```

### 10. 验证服务状态
```bash
docker ps | grep <容器名前缀>
curl http://localhost:<后端端口>/api/v1/health
docker logs <容器名> --tail 30
```

## 关键注意事项

1. **必须使用 docker-compose**：服务器上的服务依赖 PostgreSQL、Milvus、etcd、MinIO 等组件，必须通过 docker-compose 启动才能正确连接
2. **不要使用 docker run 独立启动**：独立启动会导致数据库连接失败
3. **端口映射**：后端服务映射为 `<后端端口>:8080`（宿主机端口:容器端口）
4. **配置文件位置**：服务器上的 docker-compose.yml 位于 `/home/<用户名>/docker-projects/docker-compose.yml`

## 服务依赖说明

后端服务依赖以下组件（通过 docker-compose 管理）：

- **PostgreSQL**：主数据库，端口 5433
- **Milvus**：向量数据库，端口 19531
- **etcd**：Milvus 元数据存储
- **MinIO**：Milvus 对象存储，端口 9001

## 常见问题

### 502 Bad Gateway
- 原因：使用 `docker run` 独立启动容器，导致数据库连接失败
- 解决：使用 `docker compose up -d` 启动所有服务

### 401 未提供认证token
- 原因：SSE 连接未传递认证 token
- 解决：修改 `JwtAuthInterceptor.java` 支持从 URL 参数提取 token

### 容器启动失败
- 查看日志：`docker logs <容器名>`
- 检查依赖服务：`docker ps | grep <容器名前缀>`
- 重启服务：`cd /home/<用户名>/docker-projects && docker compose restart`
