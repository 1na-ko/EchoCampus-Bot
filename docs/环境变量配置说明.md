# 环境变量配置说明

> **最后更新**：2026年1月13日

---

## 📝 配置文件说明

本项目使用 `.env` 文件管理环境变量，确保敏感信息与代码分离。

### 配置文件位置

- **模板文件**：`.env.example`（已纳入版本控制）
- **实际配置**：`.env`（已加入.gitignore，不纳入版本控制）

---

## 🚀 快速开始

### 1. 复制环境变量模板

```bash
cp .env.example .env
```

### 2. 编辑配置文件

Windows:
```bash
notepad .env
```

Linux/Mac:
```bash
nano .env
```

### 3. 填入必需的配置项

必须配置以下项目才能启动服务：
- `ALIYUN_API_KEY` - 阿里云Embedding服务密钥
- `DEEPSEEK_API_KEY` - DeepSeek LLM服务密钥
- `JWT_SECRET` - JWT签名密钥（生产环境必须修改）

---

## 📋 环境变量详细说明

### 数据库配置

| 变量名 | 说明 | 默认值 | 是否必需 |
|--------|------|--------|----------|
| `POSTGRES_DB` | PostgreSQL数据库名称 | `echocampus_bot` | ✅ 是 |
| `POSTGRES_USER` | PostgreSQL用户名 | `postgres` | ✅ 是 |
| `POSTGRES_PASSWORD` | PostgreSQL密码 | `postgres123` | ✅ 是（生产环境必须修改） |
| `POSTGRES_PORT` | PostgreSQL宿主机端口 | `5432` | ❌ 否 |

**安全建议**：
- 生产环境必须修改默认密码
- 建议使用至少20位的强密码
- 定期轮换数据库密码

生成强密码：
```bash
openssl rand -base64 32
```

---

### 后端服务配置

| 变量名 | 说明 | 默认值 | 是否必需 |
|--------|------|--------|----------|
| `BACKEND_PORT` | 后端服务宿主机端口 | `8083` | ❌ 否 |

**说明**：
- 容器内部端口固定为 `8080`
- `BACKEND_PORT` 控制映射到宿主机的端口
- 如果端口冲突，可修改此值

---

### AI服务API密钥

#### 阿里云百炼平台（Embedding服务）

| 变量名 | 说明 | 获取方式 | 是否必需 |
|--------|------|----------|----------|
| `ALIYUN_API_KEY` | 阿里云Embedding API密钥 | [获取地址](https://dashscope.console.aliyun.com/apiKey) | ✅ 是 |

**获取步骤**：
1. 访问 https://dashscope.console.aliyun.com/apiKey
2. 登录阿里云账号
3. 创建API-KEY
4. 复制密钥到 `.env` 文件

**格式示例**：
```bash
ALIYUN_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

#### DeepSeek（LLM服务）

| 变量名 | 说明 | 获取方式 | 是否必需 |
|--------|------|----------|----------|
| `DEEPSEEK_API_KEY` | DeepSeek API密钥 | [获取地址](https://platform.deepseek.com/api_keys) | ✅ 是 |

**获取步骤**：
1. 访问 https://platform.deepseek.com/api_keys
2. 注册并登录DeepSeek账号
3. 创建API密钥
4. 复制密钥到 `.env` 文件

**格式示例**：
```bash
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**注意事项**：
- API密钥包含敏感信息，请勿泄露
- 建议定期轮换API密钥
- 监控API使用量，避免超额消费

---

### JWT安全配置

| 变量名 | 说明 | 默认值 | 是否必需 |
|--------|------|--------|----------|
| `JWT_SECRET` | JWT签名密钥 | 模板中的示例值 | ✅ 是（生产环境必须修改） |

**安全要求**：
- 至少64个字符
- 包含大小写字母、数字和特殊字符
- 每个环境使用不同的密钥
- 定期轮换（建议每3-6个月）

生成强JWT密钥：
```bash
# 生成64字节（88字符）的Base64编码随机字符串
openssl rand -base64 64
```

**示例**：
```bash
JWT_SECRET=YourVeryLongAndSecureRandomStringHereMinimum64CharactersForProductionUse
```

---

### 邮件服务配置（可选）

| 变量名 | 说明 | 默认值 | 是否必需 |
|--------|------|--------|----------|
| `MAIL_USERNAME` | 邮箱用户名 | `your_email@163.com` | ❌ 否 |
| `MAIL_PASSWORD` | 邮箱密码/授权码 | - | ❌ 否 |

**说明**：
- 用于发送验证码邮件
- 使用163邮箱时需使用**授权码**而非登录密码
- 如不配置，验证码功能将不可用

**获取163邮箱授权码**：
1. 登录 https://mail.163.com/
2. 设置 → POP3/SMTP/IMAP
3. 开启服务并获取授权码
4. 复制授权码到 `.env` 文件

---

### 生产环境专用配置

#### CORS配置

| 变量名 | 说明 | 默认值 | 是否必需 |
|--------|------|--------|----------|
| `CORS_ALLOWED_ORIGINS` | 允许的CORS源 | - | 生产环境必需 |

**说明**：
- 配置允许访问后端API的前端域名
- 多个域名用逗号分隔
- 生产环境必须配置实际前端域名

**示例**：
```bash
# 单个域名
CORS_ALLOWED_ORIGINS=https://your-frontend-domain.com

# 多个域名
CORS_ALLOWED_ORIGINS=https://www.example.com,https://admin.example.com
```

#### Docker镜像配置

| 变量名 | 说明 | 默认值 | 是否必需 |
|--------|------|--------|----------|
| `DOCKER_IMAGE` | Docker镜像地址 | `echocampus-bot:latest` | 生产环境必需 |

**说明**：
- 用于生产环境从镜像仓库拉取镜像
- 包含完整的镜像仓库地址和标签

**示例**：
```bash
# 阿里云镜像仓库
DOCKER_IMAGE=registry.cn-shanghai.aliyuncs.com/your-namespace/echocampus-bot:latest

# Docker Hub
DOCKER_IMAGE=your-dockerhub-username/echocampus-bot:latest
```

#### MinIO配置（可选）

| 变量名 | 说明 | 默认值 | 是否必需 |
|--------|------|--------|----------|
| `MINIO_ACCESS_KEY` | MinIO访问密钥 | `minioadmin` | ❌ 否 |
| `MINIO_SECRET_KEY` | MinIO密钥 | `minioadmin` | ❌ 否 |
| `MINIO_PORT` | MinIO端口 | `9000` | ❌ 否 |
| `MINIO_CONSOLE_PORT` | MinIO控制台端口 | `9001` | ❌ 否 |

**说明**：
- MinIO用于Milvus向量数据库的对象存储
- 生产环境建议修改默认密钥

#### Milvus配置（可选）

| 变量名 | 说明 | 默认值 | 是否必需 |
|--------|------|--------|----------|
| `MILVUS_PORT` | Milvus服务端口 | `19530` | ❌ 否 |
| `MILVUS_METRICS_PORT` | Milvus监控端口 | `9091` | ❌ 否 |

---

## 🔐 安全最佳实践

### 1. 环境隔离

不同环境使用不同的配置：

```bash
# 开发环境
POSTGRES_PASSWORD=dev_password_123
JWT_SECRET=dev_jwt_secret_key

# 测试环境
POSTGRES_PASSWORD=test_password_456
JWT_SECRET=test_jwt_secret_key

# 生产环境
POSTGRES_PASSWORD=prod_strong_password_789
JWT_SECRET=prod_strong_jwt_secret_key
```

### 2. 密钥管理

- ✅ 使用强随机密钥
- ✅ 定期轮换密钥
- ✅ 不同环境使用不同密钥
- ❌ 不要在代码中硬编码密钥
- ❌ 不要将 `.env` 文件提交到版本控制

### 3. 备份策略

```bash
# 备份环境变量配置（移除敏感信息）
cp .env .env.backup
```

### 4. 权限控制

```bash
# Linux/Mac: 限制.env文件权限
chmod 600 .env

# 确保只有当前用户可读写
```

---

## 🌍 不同环境配置示例

### 本地开发环境

```bash
# 数据库配置（使用默认值）
POSTGRES_DB=echocampus_bot
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres123
POSTGRES_PORT=5432

# 后端服务端口
BACKEND_PORT=8083

# AI服务密钥（使用开发账号）
ALIYUN_API_KEY=sk-dev-xxxxxxxxxxxxxxxx
DEEPSEEK_API_KEY=sk-dev-xxxxxxxxxxxxxxxx

# JWT密钥（开发专用）
JWT_SECRET=DevJWTSecretKeyForLocalDevelopmentOnly

# 邮件服务（可选）
MAIL_USERNAME=dev@163.com
MAIL_PASSWORD=dev_auth_code
```

### 生产环境

```bash
# 数据库配置（使用强密码）
POSTGRES_DB=echocampus_bot
POSTGRES_USER=postgres
POSTGRES_PASSWORD=Prod@StrongPass#2024!XyZ
POSTGRES_PORT=5432

# 后端服务端口
BACKEND_PORT=8083

# AI服务密钥（使用生产账号）
ALIYUN_API_KEY=sk-prod-xxxxxxxxxxxxxxxx
DEEPSEEK_API_KEY=sk-prod-xxxxxxxxxxxxxxxx

# JWT密钥（强随机字符串）
JWT_SECRET=ProdJWTSecret2024VeryLongAndRandomStringGeneratedByOpenSSL64Chars

# 邮件服务
MAIL_USERNAME=noreply@yourdomain.com
MAIL_PASSWORD=prod_auth_code

# CORS配置（实际前端域名）
CORS_ALLOWED_ORIGINS=https://www.yourdomain.com

# Docker镜像
DOCKER_IMAGE=registry.cn-shanghai.aliyuncs.com/your-namespace/echocampus-bot:latest

# MinIO配置（生产环境修改默认密钥）
MINIO_ACCESS_KEY=prod_minio_access_key
MINIO_SECRET_KEY=prod_minio_secret_key
```

---

## ❓ 常见问题

### Q1: .env文件不生效怎么办？

**A**: 检查以下几点：
1. 文件名是否正确（`.env`，注意前面有点）
2. 文件是否在项目根目录
3. 重启Docker容器：`docker-compose -f docker-compose.dev.yml restart`

### Q2: 如何验证环境变量是否加载？

**A**: 查看容器环境变量：
```bash
docker-compose -f docker-compose.dev.yml exec echocampus-bot env | grep ALIYUN
```

### Q3: API密钥无效怎么办？

**A**:
1. 检查密钥是否正确复制（注意空格和换行）
2. 确认密钥未过期
3. 检查API配额是否用尽
4. 查看后端日志：`docker-compose -f docker-compose.dev.yml logs echocampus-bot`

### Q4: 如何在Windows上生成强密钥？

**A**: 使用Git Bash或WSL：
```bash
# Git Bash
openssl rand -base64 64

# 或者在线生成
# https://www.random.org/strings/
```

---

## 📚 相关文档

- [快速部署指南](./docs/快速部署指南.md) - 完整的部署流程
- [配置审计报告](./docs/配置审计报告.md) - 配置优化详情
- [.env.example](./.env.example) - 环境变量模板

---

**配置愉快！** 🎉
