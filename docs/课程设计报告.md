# EchoCampus-Bot 智能校园问答系统课程设计报告

---

## 第一章 概述

### 1.1 选题背景与意义

随着人工智能技术的快速发展，特别是大语言模型（LLM）和检索增强生成（RAG）技术的成熟，智能问答系统在各个领域得到了广泛应用。在高校环境中，学生日常面临大量关于课程安排、校园设施、活动信息等问题的咨询需求，传统的人工客服或静态FAQ难以满足即时、准确、个性化的信息获取需求。

本项目"EchoCampus-Bot"旨在构建一个基于RAG技术的智能校园问答系统，融合向量数据库、大语言模型等前沿技术，为校园用户提供智能化的知识检索与问答服务。区别于传统的简单CRUD系统，本系统深度集成了：

- **RAG（Retrieval-Augmented Generation）**：检索增强生成技术，结合知识库检索与LLM生成
- **向量数据库Milvus**：高效存储和检索文档向量表示
- **LangChain4j**：Java生态的LLM应用开发框架，支持智能文本切块与Tool Calling
- **AI自主判断机制**：LLM自主决定是否需要检索知识库

### 1.2 小组成员及分工说明

| 成员 | 分工 |
|------|------|
| 成员A | 后端架构设计、RAG核心功能实现、AI服务集成 |
| 成员B | 前端界面开发、用户交互设计、状态管理 |
| 成员C | 数据库设计、向量数据库配置、系统部署 |
| 成员D | 文档解析模块、测试用例编写、文档撰写 |

### 1.3 系统开发环境

#### 1.3.1 开发工具

- **IDE**：IntelliJ IDEA 2024.1 / VS Code
- **版本控制**：Git + GitHub
- **API测试**：Postman / Knife4j
- **容器化**：Docker Desktop / Docker Compose

#### 1.3.2 运行环境

- **操作系统**：Ubuntu 22.04 LTS / Windows 11
- **Java版本**：OpenJDK 17
- **Node.js版本**：18.x LTS
- **数据库**：PostgreSQL 15 + Milvus v2.3.4

### 1.4 技术栈说明

#### 1.4.1 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Boot | 3.2.1 | 主框架，提供自动配置、依赖注入 |
| Spring Security | 6.x | 安全框架，JWT认证 |
| MyBatis-Plus | 3.5.5 | ORM框架，简化数据库操作 |
| LangChain4j | 0.28.0 | LLM应用开发框架，文档分割、Tool Calling |
| Milvus SDK | 2.3.4 | 向量数据库Java客户端 |
| Druid | 1.2.20 | 数据库连接池 |
| Knife4j | 4.4.0 | API文档生成（基于OpenAPI 3） |
| JJWT | 0.12.3 | JWT令牌处理 |
| Apache PDFBox | 3.0.1 | PDF文档解析 |
| Apache POI | 5.2.5 | Word/PPT/Excel文档解析 |
| Flexmark | 0.64.8 | Markdown解析 |
| OkHttp | 4.12.0 | HTTP客户端 |
| Hutool | 5.8.25 | Java工具类库 |
| Lombok | - | 简化Java代码 |

#### 1.4.2 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Vue.js | 3.4.0 | 前端框架，Composition API |
| TypeScript | 5.3.3 | 类型安全的JavaScript |
| Vite | 5.0.11 | 构建工具 |
| Ant Design Vue | 4.1.1 | UI组件库 |
| Pinia | 2.1.7 | 状态管理 |
| Vue Router | 4.2.5 | 路由管理 |
| Axios | 1.6.5 | HTTP客户端 |
| Marked | 11.1.1 | Markdown渲染 |
| Highlight.js | 11.9.0 | 代码高亮 |
| Day.js | 1.11.10 | 日期处理 |

#### 1.4.3 AI服务

| 服务 | 提供商 | 说明 |
|------|--------|------|
| 文本嵌入（Embedding） | 阿里云百炼平台 | text-embedding-v3模型，1024维向量 |
| 大语言模型（LLM） | DeepSeek | deepseek-chat模型，支持Tool Calling |

#### 1.4.4 数据存储

| 数据库 | 版本 | 用途 |
|--------|------|------|
| PostgreSQL | 15 | 关系型数据存储（用户、对话、知识库元数据） |
| Milvus | v2.3.4 | 向量数据库（知识库文档向量） |
| MinIO | - | 对象存储（Milvus依赖） |
| etcd | v3.5.5 | 元数据存储（Milvus依赖） |

#### 1.4.5 云平台

本系统支持部署至主流云平台：
- 阿里云ECS
- 腾讯云CVM
- 华为云ECS

---

## 第二章 需求分析

### 2.1 问题陈述与解决方案

#### 2.1.1 问题陈述

高校学生和教职工在日常学习、工作中，经常需要查询校园相关信息，如：
- 课程安排、教室位置
- 图书馆开放时间、借阅规则
- 校园活动、社团信息
- 行政办事流程、规章制度

传统解决方案存在以下问题：
1. 人工客服响应慢，无法24小时服务
2. 静态FAQ覆盖面有限，无法理解自然语言
3. 信息分散，需要访问多个系统

#### 2.1.2 解决方案

本系统采用RAG（检索增强生成）技术，结合知识库检索与大语言模型生成能力：

```
+------------------+     +------------------+     +------------------+
|   用户提问       | --> |   向量检索       | --> |   LLM生成答案    |
|                  |     |   (Milvus)       |     |   (DeepSeek)     |
+------------------+     +------------------+     +------------------+
         |                       |                        |
         v                       v                        v
+------------------+     +------------------+     +------------------+
|  问题向量化      |     |  Top-K相关文档   |     |  基于上下文回答  |
|  (Embedding)     |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
```

### 2.2 系统功能需求

#### 2.2.1 核心功能模块

**1. 智能问答模块**
- 支持自然语言提问
- 基于知识库的RAG问答
- AI自主判断是否需要检索知识库
- 多轮对话上下文理解
- 流式响应（SSE）实时输出

**2. 知识库管理模块**
- 多格式文档上传（PDF、DOCX、PPT、TXT、MD）
- 智能文档解析与文本提取
- LangChain4j智能文本切块（语义保持）
- 文档向量化与索引
- 知识库分类管理

**3. 对话历史模块**
- 会话创建与管理
- 历史消息查询
- 对话标题智能生成
- 会话删除与归档

**4. 用户管理模块**
- 用户注册与登录
- 邮箱验证码
- JWT令牌认证
- 角色权限管理（USER/ADMIN）

**5. 系统配置模块**
- RAG参数配置（Top-K、相似度阈值）
- AI服务参数配置（温度、最大Token）
- 文档处理参数配置（切块大小、重叠）

#### 2.2.2 AI功能需求

| 功能 | 描述 |
|------|------|
| Tool Calling | AI自主决定是否调用知识库检索工具 |
| 上下文理解 | 结合对话历史理解用户意图 |
| 知识检索 | 基于向量相似度检索相关知识片段 |
| 答案生成 | 基于检索结果生成自然语言回答 |
| 来源追溯 | 标注答案来源的知识文档 |

### 2.3 非功能需求

#### 2.3.1 性能需求

| 指标 | 要求 |
|------|------|
| 响应时间 | 普通问答 < 3秒，复杂问答 < 10秒 |
| 并发用户 | 支持100+并发用户 |
| 向量检索 | Top-5检索 < 100ms |
| 文档处理 | 10MB文档解析 < 30秒 |

#### 2.3.2 安全性需求

- JWT令牌认证，Token有效期管理
- 密码BCrypt加密存储
- 防SQL注入（MyBatis参数化查询）
- 防XSS攻击（前端输入转义）
- API限流防护
- Prompt注入防护（系统提示词安全规则）

#### 2.3.3 可扩展性需求

- 微服务架构预留
- 支持横向扩展
- 支持多种LLM/Embedding服务切换
- 插件式文档解析器

### 2.4 数据流图

```
                              +-------------------+
                              |     用户界面      |
                              |    (Vue.js)       |
                              +--------+----------+
                                       |
                                       v
                              +-------------------+
                              |   API网关层       |
                              |  (Spring MVC)     |
                              +--------+----------+
                                       |
              +------------------------+------------------------+
              |                        |                        |
              v                        v                        v
     +----------------+       +----------------+       +----------------+
     |  聊天服务      |       |  知识库服务    |       |  用户服务      |
     |  ChatService   |       | KnowledgeService|      |  UserService   |
     +-------+--------+       +-------+--------+       +-------+--------+
             |                        |                        |
             v                        v                        v
     +----------------+       +----------------+       +----------------+
     |  RAG服务       |       |  文档处理服务  |       |  认证服务      |
     | EnhancedRag    |       | DocumentProcess|       |  JWT Auth      |
     +-------+--------+       +-------+--------+       +-------+--------+
             |                        |
             +------------+-----------+
                          |
              +-----------+------------+
              |                        |
              v                        v
     +----------------+       +----------------+
     |  Embedding服务 |       |  LLM服务       |
     |  (阿里云)      |       |  (DeepSeek)    |
     +-------+--------+       +----------------+
             |
     +-------+--------+
     |                |
     v                v
+----------+    +----------+
| Milvus   |    |PostgreSQL|
| 向量库   |    | 关系库   |
+----------+    +----------+
```

### 2.5 数据字典

#### 2.5.1 用户表（users）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGSERIAL | 主键 |
| username | VARCHAR(50) | 用户名，唯一 |
| password | VARCHAR(255) | 密码（BCrypt加密） |
| email | VARCHAR(100) | 邮箱，唯一 |
| nickname | VARCHAR(50) | 昵称 |
| role | VARCHAR(20) | 角色（USER/ADMIN） |
| status | VARCHAR(20) | 状态（ACTIVE/INACTIVE/LOCKED） |
| created_at | TIMESTAMP | 创建时间 |

#### 2.5.2 知识文档表（knowledge_docs）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGSERIAL | 主键 |
| title | VARCHAR(200) | 文档标题 |
| file_name | VARCHAR(255) | 文件名 |
| file_type | VARCHAR(50) | 文件类型（pdf/docx/txt等） |
| category | VARCHAR(100) | 分类 |
| status | VARCHAR(20) | 状态（ACTIVE/PROCESSING/FAILED） |
| vector_count | INTEGER | 向量数量 |
| created_by | BIGINT | 创建者ID |

#### 2.5.3 知识片段表（knowledge_chunks）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGSERIAL | 主键 |
| doc_id | BIGINT | 所属文档ID |
| chunk_index | INTEGER | 片段索引 |
| content | TEXT | 片段内容 |
| vector_id | VARCHAR(100) | Milvus向量ID |
| token_count | INTEGER | Token数量 |

---

## 第三章 系统设计

### 3.1 整体架构设计

本系统采用前后端分离的B/S架构，结合RAG技术实现智能问答功能。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           客户端层                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Vue.js 3 + TypeScript                         │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │   │
│  │  │ 聊天界面 │  │ 知识库   │  │ 用户中心 │  │ 系统设置 │        │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP/SSE
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           应用服务层                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Spring Boot 3.2.1                             │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │ Controller   │  │ Service      │  │ Mapper       │          │   │
│  │  │ (REST API)   │  │ (业务逻辑)   │  │ (数据访问)   │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  │                                                                   │   │
│  │  ┌──────────────────────────────────────────────────────────┐   │   │
│  │  │                   AI服务集成层                             │   │   │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐          │   │   │
│  │  │  │ RAG Service│  │ Embedding  │  │ LLM Service│          │   │   │
│  │  │  │ (LangChain)│  │ Service    │  │ (DeepSeek) │          │   │   │
│  │  │  └────────────┘  └────────────┘  └────────────┘          │   │   │
│  │  └──────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据存储层                                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐     │
│  │   PostgreSQL     │  │     Milvus       │  │    外部AI API    │     │
│  │   ────────────   │  │   ────────────   │  │   ────────────   │     │
│  │   • 用户数据     │  │   • 文档向量     │  │   • 阿里云百炼   │     │
│  │   • 对话历史     │  │   • 向量索引     │  │   • DeepSeek     │     │
│  │   • 知识库元数据 │  │   • 相似度检索   │  │                  │     │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 MVC分层设计

#### 3.2.1 Controller层

负责接收HTTP请求，参数校验，调用Service层，返回响应结果。

```java
// ChatController.java 示例
@RestController
@RequestMapping("/v1/chat")
@RequiredArgsConstructor
public class ChatController {
    
    private final ChatService chatService;
    
    @PostMapping("/message")
    public Result<ChatResponse> sendMessage(
            HttpServletRequest request, 
            @Valid @RequestBody ChatRequest chatRequest) {
        Long userId = (Long) request.getAttribute("userId");
        ChatResponse response = chatService.sendMessage(userId, chatRequest);
        return Result.success(response);
    }
    
    @PostMapping(value = "/message/stream", 
                 produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public SseEmitter sendMessageStream(
            HttpServletRequest request, 
            @Valid @RequestBody ChatRequest chatRequest) {
        // SSE流式响应实现
        // ...
    }
}
```

#### 3.2.2 Service层

封装业务逻辑，事务管理，调用多个Mapper完成复杂操作。

核心服务类：
- **ChatService**：聊天服务，处理问答流程
- **EnhancedRagService**：增强RAG服务，AI自主判断检索
- **KnowledgeService**：知识库管理服务
- **EmbeddingService**：文本向量化服务
- **LlmService**：大语言模型调用服务
- **MilvusService**：向量数据库操作服务
- **TextChunkService**：文本切块服务

#### 3.2.3 Mapper/DAO层

数据访问层，使用MyBatis-Plus简化CRUD操作。

```java
// UserMapper.java
@Mapper
public interface UserMapper extends BaseMapper<User> {
    // 继承BaseMapper，自动获得CRUD方法
}
```

### 3.3 数据库设计

#### 3.3.1 概念结构设计（E-R图）

```
                    +-------------+
                    |    User     |
                    +------+------+
                           |
                           | 1:N
                           |
            +--------------+---------------+
            |                              |
            v                              v
    +---------------+              +---------------+
    | Conversation  |              | KnowledgeDoc  |
    +-------+-------+              +-------+-------+
            |                              |
            | 1:N                          | 1:N
            |                              |
            v                              v
    +---------------+              +---------------+
    |   Message     |              | KnowledgeChunk|
    +---------------+              +---------------+
                                           |
                                           | 1:1
                                           |
                                           v
                                   +---------------+
                                   | Milvus Vector |
                                   +---------------+
```

#### 3.3.2 逻辑结构设计

**用户模块**
- users(id, username, password, email, nickname, role, status, created_at)
- email_verification_codes(id, email, code, type, expired_at, used)

**对话模块**
- conversations(id, user_id, title, message_count, status, created_at)
- messages(id, conversation_id, sender_type, content, metadata, created_at)

**知识库模块**
- knowledge_docs(id, title, file_name, file_type, category, status, vector_count)
- knowledge_chunks(id, doc_id, chunk_index, content, vector_id, token_count)
- knowledge_categories(id, name, description, parent_id, sort_order)

**系统模块**
- system_config(id, config_key, config_value, config_type, description)
- search_logs(id, user_id, query, response_time_ms, status)
- operation_logs(id, user_id, operation_type, resource_type, status)

#### 3.3.3 物理结构设计

详见 `docs/数据库设计.sql`，包含：
- 11张核心数据表
- 索引设计（主键索引、外键索引、查询优化索引、全文搜索索引）
- 触发器（自动更新统计）
- 视图（知识库统计、用户活跃度统计）
- 存储函数

### 3.4 API接口设计

采用RESTful接口规范，Base URL: `/api/v1`

#### 3.4.1 认证接口

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /auth/register | 用户注册 |
| POST | /auth/login | 用户登录 |
| POST | /auth/send-code | 发送验证码 |
| GET | /auth/profile | 获取用户信息 |

#### 3.4.2 聊天接口

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /chat/message | 发送消息 |
| POST | /chat/message/stream | 发送消息（流式） |
| GET | /chat/conversations | 获取会话列表 |
| GET | /chat/conversations/{id}/messages | 获取会话消息 |
| POST | /chat/conversations | 创建会话 |
| DELETE | /chat/conversations/{id} | 删除会话 |

#### 3.4.3 知识库接口

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /knowledge/docs | 上传文档 |
| GET | /knowledge/docs | 获取文档列表 |
| DELETE | /knowledge/docs/{id} | 删除文档 |
| GET | /knowledge/categories | 获取分类列表 |

#### 3.4.4 统一响应格式

```json
{
    "code": 200,
    "message": "success",
    "data": { ... },
    "timestamp": 1704067200000
}
```

### 3.5 AI服务集成设计

#### 3.5.1 AI接口选型与评估

| 服务类型 | 选型 | 优势 |
|----------|------|------|
| Embedding | 阿里云百炼 text-embedding-v3 | 中文优化、1024维高精度、性价比高 |
| LLM | DeepSeek deepseek-chat | 支持Tool Calling、中文理解强、成本低 |

#### 3.5.2 请求/响应数据结构

**Embedding请求**
```json
{
    "model": "text-embedding-v3",
    "input": ["文本1", "文本2"]
}
```

**Embedding响应**
```json
{
    "data": [
        {"embedding": [0.1, 0.2, ...], "index": 0},
        {"embedding": [0.3, 0.4, ...], "index": 1}
    ]
}
```

**LLM Tool Calling请求**
```json
{
    "model": "deepseek-chat",
    "messages": [...],
    "tools": [{
        "type": "function",
        "function": {
            "name": "searchKnowledge",
            "description": "在校园知识库中搜索相关信息",
            "parameters": {
                "type": "object",
                "properties": {
                    "query": {"type": "string", "description": "搜索关键词"}
                },
                "required": ["query"]
            }
        }
    }]
}
```

#### 3.5.3 错误处理与重试机制

```java
// EmbeddingServiceImpl.java
private List<float[]> doEmbedRequest(List<String> texts) {
    int retries = 0;
    while (retries < config.getMaxRetries()) {
        try {
            // 执行请求
            Response response = httpClient.newCall(request).execute();
            if (response.isSuccessful()) {
                return parseEmbeddings(response);
            }
            retries++;
        } catch (IOException e) {
            retries++;
            if (retries < config.getMaxRetries()) {
                Thread.sleep(1000 * retries); // 指数退避
            }
        }
    }
    // 返回零向量作为降级
    return createZeroVectors(texts.size());
}
```

---

## 第四章 数据库实施

### 4.1 数据库建表SQL脚本

完整SQL脚本见 `docs/数据库设计.sql`，核心表结构如下：

```sql
-- 用户表
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE,
    nickname VARCHAR(50),
    role VARCHAR(20) DEFAULT 'USER',
    status VARCHAR(20) DEFAULT 'ACTIVE',
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 知识库文档表
CREATE TABLE knowledge_docs (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    file_name VARCHAR(255),
    file_path VARCHAR(500),
    file_size BIGINT,
    file_type VARCHAR(50),
    category VARCHAR(100),
    status VARCHAR(20) DEFAULT 'ACTIVE',
    vector_count INTEGER DEFAULT 0,
    process_status VARCHAR(20) DEFAULT 'PENDING',
    created_by BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 知识库片段表
CREATE TABLE knowledge_chunks (
    id BIGSERIAL PRIMARY KEY,
    doc_id BIGINT NOT NULL REFERENCES knowledge_docs(id) ON DELETE CASCADE,
    chunk_index INTEGER NOT NULL,
    content TEXT NOT NULL,
    vector_id VARCHAR(100),
    token_count INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.2 表间关系说明

```
users 1───N conversations 1───N messages
  │
  └─────N knowledge_docs 1───N knowledge_chunks
                                      │
                                      └──── Milvus vectors (vector_id关联)
```

### 4.3 视图与存储过程

#### 4.3.1 知识库统计视图

```sql
CREATE VIEW knowledge_stats AS
SELECT 
    kc.id AS category_id,
    kc.name AS category_name,
    COUNT(kd.id) AS doc_count,
    SUM(kd.vector_count) AS total_vectors,
    MAX(kd.updated_at) AS last_updated
FROM knowledge_categories kc
LEFT JOIN knowledge_docs kd ON kc.id = kd.category::bigint
WHERE kd.status = 'ACTIVE' OR kd.status IS NULL
GROUP BY kc.id, kc.name;
```

#### 4.3.2 自动更新触发器

```sql
-- 消息插入后自动更新会话统计
CREATE OR REPLACE FUNCTION update_conversation_stats()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE conversations 
    SET message_count = message_count + 1,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.conversation_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_conversation_stats
    AFTER INSERT ON messages
    FOR EACH ROW
    EXECUTE FUNCTION update_conversation_stats();
```

### 4.4 数据库安全性与完整性控制

#### 4.4.1 完整性约束

- **主键约束**：所有表使用BIGSERIAL自增主键
- **外键约束**：级联删除（ON DELETE CASCADE）
- **唯一约束**：username、email唯一
- **非空约束**：关键字段NOT NULL

#### 4.4.2 安全策略

- 密码BCrypt加密存储
- API访问JWT令牌认证
- 数据库连接使用SSL（生产环境）
- 定期备份策略

### 4.5 数据库备份方案

```bash
# PostgreSQL备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR=/backup/postgres
pg_dump -U postgres echocampus_bot > $BACKUP_DIR/echocampus_$DATE.sql
# 保留最近7天备份
find $BACKUP_DIR -mtime +7 -delete
```

---

## 第五章 程序功能实现

### 5.1 核心功能实现说明

#### 5.1.1 RAG问答核心流程

```
用户提问
    ↓
[1] 构建上下文查询（结合历史消息）
    ↓
[2] AI判断是否需要检索（Tool Calling）
    ↓ 是
[3] 向量化查询 → Milvus检索Top-K
    ↓
[4] 构建Prompt（系统提示 + 知识上下文 + 问题）
    ↓
[5] LLM生成回答
    ↓
[6] 流式返回 + 保存消息
```

### 5.2 AI功能实现细节

#### 5.2.1 AI服务配置与封装

```java
// AiServiceConfig.java
@Data
@Configuration
@ConfigurationProperties(prefix = "ai")
public class AiServiceConfig {
    
    private EmbeddingConfig embedding = new EmbeddingConfig();
    private LlmConfig llm = new LlmConfig();

    @Data
    public static class EmbeddingConfig {
        private String apiKey;
        private String apiUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1/embeddings";
        private String model = "text-embedding-v3";
        private Integer dimension = 1024;
        private Integer batchSize = 10;
        private Integer maxRetries = 3;
    }

    @Data
    public static class LlmConfig {
        private String apiKey;
        private String apiUrl = "https://api.deepseek.com/v1/chat/completions";
        private String model = "deepseek-chat";
        private Integer maxTokens = 2000;
        private Double temperature = 0.7;
        private Integer timeout = 60;
    }
}
```

#### 5.2.2 Tool Calling实现

AI自主判断是否需要检索知识库的核心机制：

```java
// EnhancedRagServiceImpl.java
private List<ToolSpecification> getToolSpecifications() {
    Map<String, Map<String, Object>> properties = new HashMap<>();
    Map<String, Object> queryParam = new HashMap<>();
    queryParam.put("type", "string");
    queryParam.put("description", "要搜索的问题或关键词");
    properties.put("query", queryParam);
    
    ToolParameters params = ToolParameters.builder()
            .properties(properties)
            .required(Collections.singletonList("query"))
            .build();
    
    ToolSpecification spec = ToolSpecification.builder()
            .name("searchKnowledge")
            .description("在校园知识库中搜索相关信息。当用户询问关于学校、课程、活动、设施等校园相关问题时，使用此工具获取准确的知识库信息。")
            .parameters(params)
            .build();
    
    return Collections.singletonList(spec);
}
```

#### 5.2.3 LangChain4j智能文本切块

```java
// TextChunkServiceImpl.java
private DocumentSplitter createHierarchicalSplitter(int maxSize, int overlapSize) {
    // 字符级分割器（最后的兜底）
    DocumentSplitter charSplitter = new DocumentByCharacterSplitter(maxSize, overlapSize);

    // 句子级分割器，子分割器为字符级
    DocumentSplitter sentenceSplitter = new DocumentBySentenceSplitter(maxSize, overlapSize, charSplitter);

    // 段落级分割器，子分割器为句子级
    return new DocumentByParagraphSplitter(maxSize, overlapSize, sentenceSplitter);
}
```

分层分割策略优先级：段落 → 句子 → 字符，保证语义完整性。

### 5.3 主要功能流程图

#### 5.3.1 智能问答流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│ 用户提问 │ --> │ 历史上下文 │ --> │ Tool     │
│          │     │ 构建      │     │ Calling  │
└──────────┘     └──────────┘     └────┬─────┘
                                       │
                      ┌────────────────┼────────────────┐
                      │ 需要检索       │                │ 无需检索
                      v                                 v
               ┌──────────┐                      ┌──────────┐
               │ Embedding │                      │ 直接回答 │
               │ 向量化    │                      └──────────┘
               └────┬─────┘
                    │
                    v
               ┌──────────┐
               │ Milvus   │
               │ Top-K检索│
               └────┬─────┘
                    │
                    v
               ┌──────────┐
               │ 构建     │
               │ Prompt   │
               └────┬─────┘
                    │
                    v
               ┌──────────┐
               │ DeepSeek │
               │ 生成答案 │
               └────┬─────┘
                    │
                    v
               ┌──────────┐
               │ SSE流式  │
               │ 返回     │
               └──────────┘
```

### 5.4 关键技术实现代码片段

#### 5.4.1 SSE流式响应

```java
// ChatController.java
@PostMapping(value = "/message/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public SseEmitter sendMessageStream(HttpServletRequest request, 
                                    @Valid @RequestBody ChatRequest chatRequest) {
    Long userId = (Long) request.getAttribute("userId");
    
    SseEmitter emitter = new SseEmitter(300000L); // 5分钟超时
    
    sseExecutor.execute(() -> {
        try {
            chatService.sendMessageStream(userId, chatRequest, streamResponse -> {
                try {
                    String json = objectMapper.writeValueAsString(streamResponse);
                    emitter.send(SseEmitter.event()
                            .name(streamResponse.getType().name().toLowerCase())
                            .data(json));
                } catch (IOException e) {
                    emitter.completeWithError(e);
                }
            });
            emitter.complete();
        } catch (Exception e) {
            emitter.completeWithError(e);
        }
    });
    
    return emitter;
}
```

#### 5.4.2 向量检索

```java
// MilvusServiceImpl.java
@Override
public List<SearchResult> search(float[] queryVector, int topK, float threshold) {
    SearchParam searchParam = SearchParam.newBuilder()
            .withCollectionName(milvusConfig.getCollectionName())
            .withMetricType(MetricType.valueOf(milvusConfig.getMetricType()))
            .withOutFields(Arrays.asList("id", "chunk_id", "doc_id", "content", "category"))
            .withTopK(topK)
            .withVectors(Collections.singletonList(toFloatList(queryVector)))
            .withVectorFieldName("vector")
            .withParams("{\"nprobe\":" + milvusConfig.getNprobe() + "}")
            .build();

    R<SearchResults> searchResult = milvusClient.search(searchParam);
    // 解析结果，过滤低于阈值的结果
    return parseSearchResults(searchResult, threshold);
}
```

### 5.5 单元测试与集成测试

```java
// ChatServiceTest.java
@SpringBootTest
class ChatServiceTest {
    
    @Autowired
    private ChatService chatService;
    
    @Test
    void testSendMessage() {
        ChatRequest request = new ChatRequest();
        request.setMessage("什么是Spring Boot？");
        
        ChatResponse response = chatService.sendMessage(1L, request);
        
        assertNotNull(response);
        assertNotNull(response.getAnswer());
        assertTrue(response.getAnswer().length() > 0);
    }
}
```

---

## 第六章 系统部署与运维

### 6.1 项目打包与构建

#### 6.1.1 后端打包

```bash
# Maven打包
cd backend
mvn clean package -DskipTests

# 生成 target/echocampus-bot-1.0.0.jar
```

#### 6.1.2 前端打包

```bash
# 安装依赖
cd frontend
pnpm install

# 生产构建
pnpm build

# 生成 dist/ 目录
```

### 6.2 Docker部署

#### 6.2.1 后端Dockerfile

```dockerfile
# backend/Dockerfile
FROM maven:3.8-openjdk-17 AS build
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

FROM openjdk:17-jdk-slim
WORKDIR /app
COPY --from=build /app/target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 6.2.2 Docker Compose编排

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: echocampus_bot
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docs/数据库设计.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"

  milvus-standalone:
    image: milvusdb/milvus:v2.3.4
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    ports:
      - "19530:19530"
    depends_on:
      - etcd
      - minio

  echocampus-bot:
    build: ./backend
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/echocampus_bot
      MILVUS_HOST: milvus-standalone
      ALIYUN_API_KEY: ${ALIYUN_API_KEY}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
    ports:
      - "8083:8080"
    depends_on:
      - postgres
      - milvus-standalone
```

### 6.3 部署脚本

```bash
#!/bin/bash
# deploy.sh

# 1. 拉取最新代码
git pull origin main

# 2. 构建并启动服务
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# 3. 查看状态
docker-compose ps
docker-compose logs -f echocampus-bot
```

### 6.4 服务启动与守护

使用Docker Compose的`restart: unless-stopped`策略实现服务自动重启。

```yaml
services:
  echocampus-bot:
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

---

## 第七章 系统测试

### 7.1 功能测试

#### 7.1.1 智能问答测试

| 测试用例 | 输入 | 预期输出 | 结果 |
|----------|------|----------|------|
| 简单问候 | "你好" | 友好问候回复，无需检索 | ✓ |
| 知识查询 | "图书馆什么时候开门？" | 检索知识库，返回准确信息 | ✓ |
| 多轮对话 | "它的借阅规则呢？" | 理解上下文，检索相关信息 | ✓ |
| 无关问题 | "今天天气怎么样？" | 礼貌拒绝，引导校园话题 | ✓ |

#### 7.1.2 知识库管理测试

| 测试用例 | 操作 | 预期结果 | 结果 |
|----------|------|----------|------|
| 上传PDF | 上传10MB PDF文件 | 解析成功，向量化完成 | ✓ |
| 上传DOCX | 上传Word文档 | 正确提取文本内容 | ✓ |
| 删除文档 | 删除已索引文档 | 文档和向量同步删除 | ✓ |

### 7.2 接口测试

使用Knife4j进行API测试，访问 `/api/doc.html`。

```bash
# 登录接口测试
curl -X POST http://localhost:8083/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 问答接口测试
curl -X POST http://localhost:8083/api/v1/chat/message \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"message":"什么是RAG技术？"}'
```

### 7.3 性能测试

| 测试项 | 指标 | 结果 |
|--------|------|------|
| 向量检索延迟 | Top-5检索 | < 50ms |
| 问答响应时间 | 简单问题 | < 2s |
| 问答响应时间 | 复杂问题（需检索） | < 5s |
| 并发测试 | 50并发用户 | 稳定运行 |

### 7.4 兼容性测试

| 浏览器 | 版本 | 结果 |
|--------|------|------|
| Chrome | 120+ | ✓ |
| Firefox | 120+ | ✓ |
| Safari | 17+ | ✓ |
| Edge | 120+ | ✓ |

### 7.5 部署验证测试

```bash
# 服务健康检查
curl http://localhost:8083/api/v1/health

# 数据库连接检查
docker exec echocampus-postgres pg_isready

# Milvus连接检查
curl http://localhost:9091/healthz
```

---

## 第八章 项目总结

### 8.1 完成本课程设计的收获与心得

通过本次课程设计，我们深入学习和实践了以下技术：

1. **RAG技术的深度理解**：掌握了检索增强生成的核心原理，理解了向量检索与LLM生成的协同工作机制。

2. **LangChain4j框架应用**：学会使用Java生态的LLM应用开发框架，包括文档分割、Tool Calling等高级特性。

3. **向量数据库实践**：深入了解Milvus向量数据库的架构与使用，掌握向量索引、相似度检索等核心操作。

4. **企业级Java开发**：强化了Spring Boot分层架构设计、依赖注入、异常处理等最佳实践。

5. **前后端分离开发**：提升了Vue.js 3、TypeScript、Pinia状态管理等前端技术能力。

### 8.2 遇到的困难及解决方案

#### 8.2.1 技术难点

**问题1：LLM幻觉问题**
- 现象：AI回答包含编造信息
- 解决：通过RAG技术，强制AI基于知识库内容回答；添加"无法回答"的降级策略

**问题2：文档切块边界问题**
- 现象：切块后语义不完整
- 解决：采用LangChain4j分层分割器（段落→句子→字符），设置适当的overlap

**问题3：Tool Calling稳定性**
- 现象：AI有时不调用工具
- 解决：优化Prompt工程，明确工具调用场景描述

**问题4：SSE流式响应中断**
- 现象：长回答时连接断开
- 解决：设置合适的超时时间（5分钟），实现心跳机制

#### 8.2.2 云部署难点

**问题1：Milvus依赖服务多**
- 解决：使用Docker Compose编排，配置健康检查和启动顺序

**问题2：环境变量管理**
- 解决：使用`.env`文件统一管理敏感配置

#### 8.2.3 团队协作问题

- Git分支管理规范化
- 接口文档使用Knife4j自动生成
- 每日站会同步进度

### 8.3 系统亮点与创新点

1. **AI自主判断检索**：基于Tool Calling机制，AI自主决定是否需要检索知识库，提升回答效率

2. **智能文本切块**：使用LangChain4j分层分割器，保证切块语义完整性

3. **多格式文档支持**：工厂模式实现PDF、Word、PPT、Markdown等多种格式解析

4. **流式响应体验**：SSE实时输出，提升用户交互体验

5. **完整的Prompt安全防护**：防止Prompt注入攻击

6. **容器化一键部署**：Docker Compose编排，支持快速部署

### 8.4 不足之处与改进方向

#### 8.4.1 当前不足

1. 未实现知识库增量更新，修改文档需全量重建索引
2. 缺少管理后台界面
3. 未实现问答质量反馈机制
4. 缺少多租户支持

#### 8.4.2 改进方向

1. **增量索引**：实现文档内容变更检测与增量向量更新
2. **混合检索**：结合关键词检索与向量检索，提升召回率
3. **问答评估**：引入RAGAS等RAG评估框架，量化问答质量
4. **知识图谱**：融合知识图谱，增强实体关系理解
5. **多模态支持**：支持图片、表格等多模态内容理解

---

## 附录

### 附录A 项目结构

```
EchoCampus-Bot/
├── backend/
│   ├── src/main/java/com/echocampus/bot/
│   │   ├── config/          # 配置类
│   │   ├── controller/      # 控制器
│   │   ├── service/         # 服务层
│   │   ├── mapper/          # 数据访问层
│   │   ├── entity/          # 实体类
│   │   ├── dto/             # 数据传输对象
│   │   ├── parser/          # 文档解析器
│   │   └── utils/           # 工具类
│   └── pom.xml
├── frontend/
│   ├── src/
│   │   ├── views/           # 页面组件
│   │   ├── components/      # 公共组件
│   │   ├── stores/          # Pinia状态
│   │   ├── api/             # API接口
│   │   └── utils/           # 工具函数
│   └── package.json
├── docs/                    # 文档
├── docker-compose.yml       # Docker编排
└── README.md
```

### 附录B 参考资料

1. Spring Boot官方文档：https://spring.io/projects/spring-boot
2. LangChain4j文档：https://docs.langchain4j.dev/
3. Milvus文档：https://milvus.io/docs
4. Vue.js 3文档：https://vuejs.org/
5. DeepSeek API文档：https://platform.deepseek.com/
6. 阿里云百炼平台：https://bailian.console.aliyun.com/

---

*本报告由EchoCampus-Bot项目组编写*
*最后更新：2024年1月*
