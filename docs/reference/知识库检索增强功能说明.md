# 知识库检索增强功能说明

> **最后更新**: 2026年1月14日  
> **适用版本**: EchoCampus-Bot 1.0.0

---

## 概述

EchoCampus-Bot 实现了两个重要的智能检索功能：

1. **AI自主判断检索** - AI可以根据用户问题自主决定是否需要检索知识库
2. **上下文相关检索** - 检索时会结合对话历史上下文，提高检索准确性

## 功能详情

### 1. AI自主判断检索

#### 工作原理
- 使用LangChain4j的工具调用（Tool Calling）功能
- AI根据用户问题内容自主决定是否需要查询知识库
- 对于简单问候、感谢等无需知识库的问题，直接回答，提升响应速度

#### 示例场景
- ✅ **需要检索**：
  - "学校图书馆在哪里？" → AI调用知识库检索工具
  - "选课系统怎么用？" → AI调用知识库检索工具
  - "校园网如何连接？" → AI调用知识库检索工具

- ❌ **无需检索**：
  - "你好" → AI直接回答
  - "谢谢" → AI直接回答
  - "再见" → AI直接回答

### 2. 上下文相关检索

#### 工作原理
- 检索时会结合最近3轮对话历史（6条消息）
- 构建包含上下文的查询，提高检索准确性
- 对追问、代词引用等场景特别有效

#### 示例场景
```
用户: "图书馆在哪里？"
助手: "图书馆位于学校东区..."

用户: "它的开放时间是？"  ← 这里的"它"指代图书馆
助手: [系统会结合上文"图书馆"进行检索，准确理解用户意图]
```

## 技术实现

### 核心组件

1. **KnowledgeSearchTool** - 知识库检索工具
   - 位置: `com.echocampus.bot.service.tool.KnowledgeSearchTool`
   - 功能: 提供给AI调用的知识库检索接口
   - 特点: 使用LangChain4j的@Tool注解标注

2. **EnhancedLlmService** - 增强LLM服务
   - 位置: `com.echocampus.bot.service.EnhancedLlmService`
   - 功能: 支持工具调用的LLM服务接口
   - 实现: 基于DeepSeek API的工具调用功能

3. **EnhancedRagService** - 增强RAG服务
   - 位置: `com.echocampus.bot.service.EnhancedRagService`
   - 功能: 整合上下文检索和AI自主判断的RAG服务
   - 特点: 自动构建上下文相关的查询

### 依赖更新

在`pom.xml`中添加了LangChain4j OpenAI集成：
```xml
<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-open-ai</artifactId>
    <version>0.28.0</version>
</dependency>
```

### 配置项

在`application.yml`中新增配置：
```yaml
rag:
  # 是否启用增强模式（AI自主判断是否检索）
  enhanced-mode: true
  # 其他配置保持不变
  top-k: 15
  similarity-threshold: 0.4
  max-context-length: 4000
```

## 使用方式

### 启用/禁用增强模式

在`application.yml`或`application-local.yml`中设置：

```yaml
rag:
  enhanced-mode: true  # 启用增强模式（默认）
  # enhanced-mode: false  # 禁用，使用传统模式
```

- **enhanced-mode: true** - 使用增强模式，支持AI自主判断和上下文检索
- **enhanced-mode: false** - 使用传统模式，每次都检索知识库

### 前端无需修改

本次更新完全向后兼容，前端代码无需任何修改：
- API接口保持不变
- 响应格式保持不变
- 流式响应保持不变

## 优势

### 1. 提升用户体验
- 简单问题响应更快（无需等待知识库检索）
- 追问更智能（理解上下文）
- 回答更准确（上下文相关检索）

### 2. 降低系统负载
- 减少不必要的向量检索操作
- 减少Milvus数据库查询
- 优化资源使用

### 3. 保持兼容性
- 完全向后兼容
- 可通过配置切换模式
- 不影响现有业务逻辑

## 工作流程

### 增强模式流程

```
用户提问
    ↓
构建上下文查询（结合历史消息）
    ↓
调用增强LLM服务
    ↓
AI分析问题 → 是否需要检索？
    ├─ 需要 → 调用KnowledgeSearchTool
    │           ↓
    │       向量检索知识库
    │           ↓
    │       返回相关内容给AI
    │           ↓
    └─ 不需要 → 直接生成回答
              ↓
          返回最终答案
```

### 传统模式流程（兼容模式）

```
用户提问
    ↓
向量化问题
    ↓
检索知识库（总是执行）
    ↓
构建上下文
    ↓
生成回答
    ↓
返回答案
```

## 注意事项

1. **API密钥**: 确保DeepSeek API密钥有效且支持工具调用功能
2. **响应时间**: 增强模式可能会因工具调用而略微增加响应时间，但对于无需检索的问题会更快
3. **上下文窗口**: 上下文检索会使用最近3轮对话，如需调整可修改`EnhancedRagServiceImpl.buildContextualQuery()`方法
4. **工具调用迭代**: 最大支持5次工具调用迭代，可在`EnhancedLlmServiceImpl`中调整

## 测试建议

### 功能测试
1. 测试简单问候是否快速响应（无检索）
2. 测试知识性问题是否正确检索
3. 测试追问是否理解上下文
4. 测试流式响应是否正常

### 性能测试
1. 对比启用/禁用增强模式的响应时间
2. 监控Milvus查询频率变化
3. 检查系统资源使用情况

## 故障排查

### 如果遇到问题

1. **AI总是不检索** - 检查系统提示词是否正确设置
2. **工具调用失败** - 检查DeepSeek API是否支持工具调用
3. **上下文理解错误** - 检查历史消息是否正确传递
4. **响应变慢** - 考虑切换回传统模式（`enhanced-mode: false`）

### 日志查看

关键日志包含：
- `AI调用知识库检索工具: query=xxx`
- `AI决定检索知识库: query=xxx`
- `增强RAG问答开始/完成`

## 后续优化建议

1. **缓存机制** - 对频繁查询的问题增加缓存
2. **检索策略** - 根据问题类型选择不同的检索参数
3. **工具扩展** - 添加更多工具（如日程查询、天气查询等）
4. **性能监控** - 添加工具调用次数、检索命中率等指标

## 版本信息

- 更新日期: 2026年1月10日
- LangChain4j版本: 0.28.0
- 影响范围: 后端RAG服务
- 兼容性: 完全向后兼容
