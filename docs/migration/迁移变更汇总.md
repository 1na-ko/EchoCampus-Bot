# PostgreSQL + pgvector è¿ç§»å˜æ›´æ±‡æ€»

> ç‰ˆæœ¬: 1.0.0  
> æ—¥æœŸ: 2026å¹´1æœˆ14æ—¥

## ğŸ“‹ å˜æ›´æ¦‚è¿°

æœ¬æ¬¡è¿ç§»å°†å‘é‡å­˜å‚¨ä»Milvusè¿ç§»åˆ°PostgreSQL+pgvectorï¼Œå®ç°ç»Ÿä¸€æ•°æ®åº“æ¶æ„ã€‚

## ğŸ†• æ–°å¢æ–‡ä»¶

### é…ç½®ç±»
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [PgVectorConfig.java](backend/src/main/java/com/echocampus/bot/config/PgVectorConfig.java) | pgvectoré…ç½®ç±» |
| [VectorProviderConfig.java](backend/src/main/java/com/echocampus/bot/config/VectorProviderConfig.java) | å‘é‡å­˜å‚¨æä¾›è€…é…ç½® |

### æœåŠ¡æ¥å£ä¸å®ç°
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [VectorService.java](backend/src/main/java/com/echocampus/bot/service/VectorService.java) | ç»Ÿä¸€å‘é‡æœåŠ¡æ¥å£ |
| [PgVectorServiceImpl.java](backend/src/main/java/com/echocampus/bot/service/impl/PgVectorServiceImpl.java) | pgvectoræœåŠ¡å®ç° |
| [VectorServiceRouter.java](backend/src/main/java/com/echocampus/bot/service/impl/VectorServiceRouter.java) | å‘é‡æœåŠ¡è·¯ç”±å™¨ |
| [VectorMigrationService.java](backend/src/main/java/com/echocampus/bot/service/VectorMigrationService.java) | è¿ç§»æœåŠ¡æ¥å£ |
| [VectorMigrationServiceImpl.java](backend/src/main/java/com/echocampus/bot/service/impl/VectorMigrationServiceImpl.java) | è¿ç§»æœåŠ¡å®ç° |

### æ§åˆ¶å™¨
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [VectorMigrationController.java](backend/src/main/java/com/echocampus/bot/controller/VectorMigrationController.java) | è¿ç§»ç®¡ç†API |

### Dockeré…ç½®
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [docker-compose.pgvector.yml](docker-compose.pgvector.yml) | pgvectorç‰ˆDocker Composeé…ç½® |

### è„šæœ¬
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [scripts/init-pgvector.sql](scripts/init-pgvector.sql) | PostgreSQLåˆå§‹åŒ–è„šæœ¬ |
| [scripts/migrate-to-pgvector.sh](scripts/migrate-to-pgvector.sh) | Linuxè¿ç§»è„šæœ¬ |
| [scripts/migrate-to-pgvector.ps1](scripts/migrate-to-pgvector.ps1) | Windowsè¿ç§»è„šæœ¬ |

### æµ‹è¯•ç±»
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [PgVectorServiceTest.java](backend/src/test/java/com/echocampus/bot/service/PgVectorServiceTest.java) | pgvectoræœåŠ¡å•å…ƒæµ‹è¯• |
| [VectorServiceRouterTest.java](backend/src/test/java/com/echocampus/bot/service/VectorServiceRouterTest.java) | æœåŠ¡è·¯ç”±å™¨å•å…ƒæµ‹è¯• |

### æ–‡æ¡£
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [docs/migration/pgvectorè¿ç§»å®æ–½æŒ‡å—.md](docs/migration/pgvectorè¿ç§»å®æ–½æŒ‡å—.md) | å®Œæ•´è¿ç§»æŒ‡å— |

## âœï¸ ä¿®æ”¹æ–‡ä»¶

### é…ç½®æ–‡ä»¶
| æ–‡ä»¶ | å˜æ›´è¯´æ˜ |
|------|----------|
| [application.yml](backend/src/main/resources/application.yml) | æ–°å¢vectoré…ç½®èŠ‚ï¼Œä¿ç•™milvusé…ç½®ç”¨äºå›æ»š |
| [.env.example](.env.example) | æ–°å¢VECTOR_PROVIDERç¯å¢ƒå˜é‡ |

### ä¸šåŠ¡ä»£ç 
| æ–‡ä»¶ | å˜æ›´è¯´æ˜ |
|------|----------|
| [KnowledgeSearchTool.java](backend/src/main/java/com/echocampus/bot/service/tool/KnowledgeSearchTool.java) | ä½¿ç”¨VectorServiceæ›¿ä»£MilvusService |
| [DocumentProcessServiceImpl.java](backend/src/main/java/com/echocampus/bot/service/impl/DocumentProcessServiceImpl.java) | ä½¿ç”¨VectorServiceæ›¿ä»£MilvusService |

### æ–‡æ¡£
| æ–‡ä»¶ | å˜æ›´è¯´æ˜ |
|------|----------|
| [README.md](README.md) | æ–°å¢pgvectoræ¶æ„è¯´æ˜ï¼Œæ›´æ–°æŠ€æœ¯æ ˆæè¿° |

## ğŸ”§ é…ç½®å˜æ›´

### application.ymlæ–°å¢é…ç½®
```yaml
# å‘é‡å­˜å‚¨é…ç½®
vector:
  provider: ${VECTOR_PROVIDER:pgvector}  # pgvector æˆ– milvus
  enabled: true
  dimension: 1024
  
  pgvector:
    dimension: 1024
    table-name: knowledge_vectors
    index-type: hnsw
    distance-type: cosine
    hnsw-m: 16
    hnsw-ef-construction: 64
    hnsw-ef-search: 100
    auto-create-table: true
    batch-size: 100
```

### ç¯å¢ƒå˜é‡æ–°å¢
```bash
VECTOR_PROVIDER=pgvector  # å‘é‡å­˜å‚¨æä¾›è€…
```

## ğŸ“¦ ä¾èµ–å˜æ›´

æ— éœ€æ–°å¢Mavenä¾èµ–ï¼Œpgvectoré€šè¿‡PostgreSQL JDBCç›´æ¥æ“ä½œã€‚

## ğŸ”„ è¿ç§»API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/v1/admin/migration/milvus-to-pgvector` | POST | å¯åŠ¨Milvusåˆ°pgvectorè¿ç§» |
| `/v1/admin/migration/pgvector-to-milvus` | POST | å¯åŠ¨pgvectoråˆ°Milvusè¿ç§»ï¼ˆå›æ»šï¼‰ |
| `/v1/admin/migration/progress` | GET | æŸ¥è¯¢è¿ç§»è¿›åº¦ |
| `/v1/admin/migration/cancel` | POST | å–æ¶ˆè¿ç§»ä»»åŠ¡ |
| `/v1/admin/migration/validate` | POST | éªŒè¯è¿ç§»ç»“æœ |
| `/v1/admin/migration/cleanup/{source}` | DELETE | æ¸…ç†æºæ•°æ® |

## ğŸ”§ æ„å»ºéªŒè¯ä¸ä¿®å¤è®°å½•

### 2026å¹´1æœˆ15æ—¥æ„å»ºéªŒè¯

**åˆå§‹æ„å»ºé—®é¢˜:**
1. `VectorMigrationController.java` ç¬¬86è¡Œ `Result.error()` æ–¹æ³•ç­¾åä¸åŒ¹é…
   - åŸå› : `Result.error(String, boolean)` æ–¹æ³•ä¸å­˜åœ¨
   - ä¿®å¤: æ”¹ä¸ºåˆ†æ­¥è®¾ç½® `result.setData(false)`

**æµ‹è¯•é—®é¢˜ä¿®å¤:**
1. `PgVectorServiceTest.testArrayToVectorString` - UnnecessaryStubbingException
   - åŸå› : æµ‹è¯•ä¸­æœ‰æœªä½¿ç”¨çš„ mock stubbing
   - ä¿®å¤: æ·»åŠ  `@MockitoSettings(strictness = Strictness.LENIENT)` å¹¶é‡æ„æµ‹è¯•

2. `VectorServiceRouterTest` - å¤šä¸ªNullPointerException
   - åŸå› : Mockitoæ— æ³•æ­£ç¡®mockæ¥å£æ–¹æ³•
   - ä¿®å¤: é‡å†™æµ‹è¯•ç±»ï¼Œä¸“æ³¨äºæµ‹è¯•æ— ä¾èµ–æœåŠ¡æ—¶çš„è¡Œä¸ºå’Œé…ç½®ç±»

3. `VectorServiceRouterTest.testVectorProviderConfigDefaults/Settings`
   - åŸå› : `VectorProviderConfig.isEnabled()` æ–¹æ³•ä¸å­˜åœ¨ï¼ˆLombokç”Ÿæˆçš„æ˜¯ `getEnabled()`ï¼‰
   - ä¿®å¤: ä¿®æ­£æµ‹è¯•ä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œå¹¶æ›´æ–°é»˜è®¤å€¼æ–­è¨€

**æœ€ç»ˆæ„å»ºç»“æœ:**
```
Tests run: 128, Failures: 0, Errors: 0, Skipped: 37
BUILD SUCCESS
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**: ä¿ç•™äº†MilvusServiceï¼Œå¯é€šè¿‡é…ç½®åˆ‡æ¢å›Milvus
2. **æ•°æ®å®‰å…¨**: è¿ç§»å‰åŠ¡å¿…å¤‡ä»½æ•°æ®
3. **æ€§èƒ½æµ‹è¯•**: å»ºè®®åœ¨æ­£å¼è¿ç§»å‰è¿›è¡Œæ€§èƒ½å¯¹æ¯”æµ‹è¯•
4. **å›æ»šé¢„æ¡ˆ**: å¦‚é‡é—®é¢˜å¯éšæ—¶åˆ‡æ¢å›Milvusæ¶æ„

## ğŸ“ æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜è¯·å‚è€ƒ [pgvectorè¿ç§»å®æ–½æŒ‡å—](docs/migration/pgvectorè¿ç§»å®æ–½æŒ‡å—.md) æˆ–æŸ¥çœ‹é¡¹ç›®Issueã€‚
